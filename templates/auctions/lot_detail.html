<!-- templates/auctions/lot_detail.html -->
{% extends 'base.html' %}
{% block page_id %}lot_detail{% endblock %}
{% block content %}
<h1>{{ lot.title }}</h1>
<div class="row">
    <div class="col-md-6">
        {% if lot.main_image %}
        <img src="{{ lot.main_image.url }}" class="img-fluid" alt="{{ lot.title }}">
        {% endif %}
        <div class="row">
            {% if lot.additional_image_1 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_1.url }}" class="img-fluid"
                    alt="Доп. изображение 1"></div>
            {% endif %}
            {% if lot.additional_image_2 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_2.url }}" class="img-fluid"
                    alt="Доп. изображение 2"></div>
            {% endif %}
            {% if lot.additional_image_3 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_3.url }}" class="img-fluid"
                    alt="Доп. изображение 3"></div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        {% if not lot.is_auction_ended %}
        <p>Время до окончания: {{ lot.auction_end|timeuntil }}</p>
        {% endif %}
        <p>Автор: {{ lot.created_by.username }}</p>
        <p>Начальная цена: {{ lot.initial_price }}</p>
        <p>Текущая ставка: <span id="current-price">{{ lot.current_price|default:"Нет ставок" }}</span></p>
        <p>Минимальный шаг ставки: {{ lot.bid_step }}</p>
        <p>Состояние: {{ lot.get_condition_display }}</p>
        <p>Теги: {{ lot.tags|default:"Не указаны" }}</p>
        <p>Местоположение: {{ location }}</p>
        <div id="bidders-list">
            {% if unique_bidders %}
            <p>Все участники:</p>
            <ul class="list-group">
                {% for bidder in unique_bidders %}
                <li
                    class="list-group-item {% if bidder.max_amount == lot.current_price %}list-group-item-success{% endif %}">
                    {{ bidder.user__username }} (ставка: {{ bidder.max_amount }})
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>Ставок пока нет.</p>
            {% endif %}
        </div>
        {% if user.is_authenticated and not lot.is_auction_ended %}
        {% if is_author %}
        <p>Вы не можете делать ставки на свой лот.</p>
        {% if not lot.has_bids %}
        <a href="{% url 'edit_lot' lot.pk %}" class="btn btn-warning">Редактировать лот</a>
        <form method="post" style="display:inline;" onsubmit="return confirm('Вы уверены, что хотите отменить лот?');">
            {% csrf_token %}
            <input type="hidden" name="cancel_lot" value="true">
            <button type="submit" class="btn btn-danger">Отменить лот</button>
        </form>
        {% endif %}
        {% else %}
        <h4>Сделать ставку</h4>
        <form method="post" id="bid-form">
            {% csrf_token %}
            {{ bid_form }}
            <button type="submit" name="bid" class="btn btn-success">Сделать ставку</button>
        </form>
        <h4>Установить автоматическую ставку</h4>
        {% if user_auto_bid %}
        {% if not current_bid or current_bid.amount != lot.current_price %}
        <p>Ваша автоматическая ставка: {{ user_auto_bid.max_amount }} (перебита)</p>
        <form method="post" id="auto-bid-form">
            {% csrf_token %}
            {{ auto_bid_form }}
            <button type="submit" name="auto_bid" class="btn btn-primary">Установить новую автоставку</button>
        </form>
        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить автоматическую ставку?');">
            {% csrf_token %}
            <input type="hidden" name="remove_auto_bid" value="true">
            <button type="submit" class="btn btn-danger">Удалить автоставку</button>
        </form>
        {% else %}
        <p>Ваша автоматическая ставка: {{ user_auto_bid.max_amount }} (лидирует)</p>
        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить автоматическую ставку?');">
            {% csrf_token %}
            <input type="hidden" name="remove_auto_bid" value="true">
            <button type="submit" class="btn btn-danger">Удалить автоставку</button>
        </form>
        {% endif %}
        {% else %}
        <form method="post" id="auto-bid-form">
            {% csrf_token %}
            {{ auto_bid_form }}
            <button type="submit" name="auto_bid" class="btn btn-primary">Установить автоставку</button>
        </form>
        {% endif %}
        {% endif %}
        {% elif lot.is_auction_ended %}
        <p id="auction-ended-message">Аукцион завершен.</p>
        {% else %}
        <p><a href="{% url 'login' %}">Авторизуйтесь</a>, чтобы сделать ставку.</p>
        {% endif %}
    </div>
</div>

<h2>Описание</h2>
<p>{{ lot.description }}</p>

<h2>Комментарии</h2>
{% if user.is_authenticated and not lot.is_auction_ended %}
<form method="post" id="comment-form">
    {% csrf_token %}
    {{ comment_form }}
    <button type="submit" name="comment" class="btn btn-primary">Добавить комментарий</button>
</form>
{% elif lot.is_auction_ended %}
<p>Комментарии нельзя оставлять после завершения аукциона.</p>
{% else %}
<p><a href="{% url 'login' %}">Авторизуйтесь</a>, чтобы оставить комментарий.</p>
{% endif %}
<div id="comments-list">
    {% for comment in lot.comments.all %}
    <div class="card mt-2">
        <div class="card-body">
            <p>{{ comment.content }}</p>
            <p>Автор: {{ comment.user.username }} | {{ comment.created_at }}</p>
        </div>
    </div>
    {% empty %}
    <p>Комментариев пока нет.</p>
    {% endfor %}
</div>
{% endblock %}