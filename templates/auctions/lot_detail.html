<!-- templates/auctions/lot_detail.html -->
{% extends 'base.html' %}
{% block page_id %}lot_detail{% endblock %}
{% block content %}

<style>
    .lot-detail .row {
        margin-bottom: 3rem;
    }

    .lot-detail img.img-fluid {
        max-width: 100%;
        height: auto;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        box-shadow: 0 0 20px rgba(0, 247, 255, 0.4);
        transition: transform 0.3s ease;
    }

    .lot-detail img.img-fluid:hover {
        transform: scale(1.05);
    }

    .lot-detail .col-md-6 {
        padding: 1.5rem;
    }

    .lot-detail p {
        margin: 0.7rem 0;
        color: #cbd5e1;
    }

    .lot-detail .list-group-item {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid #00f7ff;
        margin-bottom: 0.7rem;
        border-radius: 10px;
        padding: 1rem;
        transition: background 0.3s ease;
    }

    .lot-detail .list-group-item-success {
        background: rgba(34, 197, 94, 0.2);
        border-color: #22c55e;
    }

    .card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 2px solid #00f7ff;
        border-radius: 15px;
        margin-bottom: 1.5rem;
        box-shadow: 0 5px 20px rgba(0, 247, 255, 0.3);
        transition: transform 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
    }

    .card-body {
        padding: 2rem;
    }

    .card-body p {
        margin: 0.5rem 0;
    }

    .replies-container .card {
        margin-left: 3rem;
        border-color: #ff007a;
    }

    #bid-form,
    #auto-bid-form,
    #comment-form {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: 15px;
        border: 2px solid #00f7ff;
        box-shadow: 0 5px 20px rgba(0, 247, 255, 0.3);
        margin-bottom: 2rem;
    }

    @media (max-width: 768px) {
        .lot-detail .col-md-6 {
            padding: 1rem;
        }

        .replies-container .card {
            margin-left: 1.5rem;
        }
    }
</style>

<h1>{{ lot.title }}</h1>
<div class="row">
    <div class="col-md-6">
        {% if lot.main_image %}
        <img src="{{ lot.main_image.url }}" class="img-fluid" alt="{{ lot.title }}">
        {% endif %}
        <div class="row">
            {% if lot.additional_image_1 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_1.url }}" class="img-fluid"
                    alt="Доп. изображение 1"></div>
            {% endif %}
            {% if lot.additional_image_2 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_2.url }}" class="img-fluid"
                    alt="Доп. изображение 2"></div>
            {% endif %}
            {% if lot.additional_image_3 %}
            <div class="col-md-4"><img src="{{ lot.additional_image_3.url }}" class="img-fluid"
                    alt="Доп. изображение 3"></div>
            {% endif %}
        </div>
    </div>
    <div class="col-md-6">
        {% if not lot.is_auction_ended %}
        <p id="time-until">Время до окончания: {{ lot.auction_end|timeuntil }}</p>
        {% endif %}
        <p>Автор: {{ lot.created_by.username }}</p>
        <p>Начальная цена: {{ lot.initial_price }}</p>
        <p>Текущая ставка: <span id="current-price">{{ lot.current_price|default:"Нет ставок" }}</span></p>
        <p>Минимальный шаг ставки: {{ lot.bid_step }}</p>
        <p>Состояние: {{ lot.get_condition_display }}</p>
        <p>Теги: {{ lot.tags|default:"Не указаны" }}</p>
        <p>Местоположение: {{ location }}</p>
        <div id="bidders-list">
            {% if unique_bidders %}
            <p>Все участники:</p>
            <ul class="list-group">
                {% for bidder in unique_bidders %}
                <li
                    class="list-group-item {% if bidder.max_amount == lot.current_price %}list-group-item-success{% endif %}">
                    {{ bidder.user__username }} (ставка: {{ bidder.max_amount }})
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>Ставок пока нет.</p>
            {% endif %}
        </div>
        {% if user.is_authenticated and not lot.is_auction_ended %}
        {% if is_author %}
        <p>Вы не можете делать ставки на свой лот.</p>
        {% if not lot.has_bids %}
        <a href="{% url 'edit_lot' lot.pk %}" class="btn btn-warning">Редактировать лот</a>
        <form method="post" style="display:inline;" onsubmit="return confirm('Вы уверены, что хотите отменить лот?');">
            {% csrf_token %}
            <input type="hidden" name="cancel_lot" value="true">
            <button type="submit" class="btn btn-danger">Отменить лот</button>
        </form>
        {% endif %}
        {% else %}
        <h4>Сделать ставку</h4>
        <form method="post" id="bid-form">
            {% csrf_token %}
            {{ bid_form }}
            <button type="submit" name="bid" class="btn btn-success">Сделать ставку</button>
        </form>
        <h4>Установить автоматическую ставку</h4>
        {% if user_auto_bid %}
        {% if not current_bid or current_bid.amount != lot.current_price %}
        <p>Ваша автоматическая ставка: {{ user_auto_bid.max_amount }} (перебита)</p>
        <form method="post" id="auto-bid-form">
            {% csrf_token %}
            {{ auto_bid_form }}
            <button type="submit" name="auto_bid" class="btn btn-primary">Установить новую автоставку</button>
        </form>
        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить автоматическую ставку?');">
            {% csrf_token %}
            <input type="hidden" name="remove_auto_bid" value="true">
            <button type="submit" class="btn btn-danger">Удалить автоставку</button>
        </form>
        {% else %}
        <p>Ваша автоматическая ставка: {{ user_auto_bid.max_amount }} (лидирует)</p>
        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить автоматическую ставку?');">
            {% csrf_token %}
            <input type="hidden" name="remove_auto_bid" value="true">
            <button type="submit" class="btn btn-danger">Удалить автоставку</button>
        </form>
        {% endif %}
        {% else %}
        <form method="post" id="auto-bid-form">
            {% csrf_token %}
            {{ auto_bid_form }}
            <button type="submit" name="auto_bid" class="btn btn-primary">Установить автоставку</button>
        </form>
        {% endif %}
        {% endif %}
        {% elif lot.is_auction_ended %}
        <p id="auction-ended-message">Аукцион завершен.</p>
        {% else %}
        <p><a href="{% url 'login' %}">Авторизуйтесь</a>, чтобы сделать ставку.</p>
        {% endif %}
    </div>
</div>

<h2>Описание</h2>
<p>{{ lot.description }}</p>

<h2>Комментарии</h2>
{% if user.is_authenticated and not lot.is_auction_ended %}
<form method="post" id="comment-form">
    {% csrf_token %}
    {{ comment_form }}
    <button type="submit" name="comment" class="btn btn-primary">Добавить комментарий</button>
</form>
{% elif lot.is_auction_ended %}
<p>Комментарии нельзя оставлять после завершения аукциона.</p>
{% else %}
<p><a href="{% url 'login' %}">Авторизуйтесь</a>, чтобы оставить комментарий.</p>
{% endif %}
<div id="comments-list">
    {% for comment in root_comments %}
    <div class="card mt-2" id="comment-{{ comment.id }}">
        <div class="card-body">
            <p>{{ comment.content }}</p>
            <p>Автор: {{ comment.user.username }} | {{ comment.created_at }}</p>
            {% if user.is_authenticated and comment.user == user and comment.can_edit_or_delete %}
            <button class="btn btn-sm btn-warning edit-comment-btn"
                data-comment-id="{{ comment.id }}">Редактировать</button>
            <form method="post" style="display:inline;" onsubmit="return confirm('Удалить комментарий?');"
                class="delete-comment-form">
                {% csrf_token %}
                <input type="hidden" name="delete_comment" value="true">
                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
            </form>
            <form method="post" class="edit-comment-form" style="display:none;" data-comment-id="{{ comment.id }}">
                {% csrf_token %}
                <textarea name="content" rows="3" class="form-control">{{ comment.content }}</textarea>
                <input type="hidden" name="edit_comment" value="true">
                <input type="hidden" name="comment_id" value="{{ comment.id }}">
                <button type="submit" class="btn btn-sm btn-success mt-2">Сохранить</button>
                <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-edit-btn">Отмена</button>
            </form>
            {% endif %}
            {% if user.is_authenticated and not lot.is_auction_ended %}
            <button class="btn btn-sm btn-primary reply-comment-btn"
                data-comment-id="{{ comment.id }}">Ответить</button>
            <form method="post" class="reply-comment-form" style="display:none;" data-comment-id="{{ comment.id }}">
                {% csrf_token %}
                <textarea name="content" rows="3" class="form-control" placeholder="Ваш ответ"></textarea>
                <input type="hidden" name="comment" value="true">
                <input type="hidden" name="parent" value="{{ comment.id }}">
                <button type="submit" class="btn btn-sm btn-primary mt-2">Отправить ответ</button>
                <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-reply-btn">Отмена</button>
            </form>
            {% endif %}
            {% if comment.replies.count %}
            <button class="btn btn-sm btn-info show-replies-btn" data-comment-id="{{ comment.id }}"
                data-replies-count="{{ comment.replies.count }}">
                Показать ответы ({{ comment.replies.count }})
            </button>
            <div class="replies-container" id="replies-{{ comment.id }}" style="display:none;">
                {% for reply in comment.replies.all %}
                <div class="card mt-2 ms-4" id="comment-{{ reply.id }}">
                    <div class="card-body">
                        <p>{{ reply.content }}</p>
                        <p>Автор: {{ reply.user.username }} | {{ reply.created_at }}</p>
                        {% if user.is_authenticated and reply.user == user and reply.can_edit_or_delete %}
                        <button class="btn btn-sm btn-warning edit-comment-btn"
                            data-comment-id="{{ reply.id }}">Редактировать</button>
                        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить ответ?');"
                            class="delete-comment-form">
                            {% csrf_token %}
                            <input type="hidden" name="delete_comment" value="true">
                            <input type="hidden" name="comment_id" value="{{ reply.id }}">
                            <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                        </form>
                        <form method="post" class="edit-comment-form" style="display:none;"
                            data-comment-id="{{ reply.id }}">
                            {% csrf_token %}
                            <textarea name="content" rows="3" class="form-control">{{ reply.content }}</textarea>
                            <input type="hidden" name="edit_comment" value="true">
                            <input type="hidden" name="comment_id" value="{{ reply.id }}">
                            <button type="submit" class="btn btn-sm btn-success mt-2">Сохранить</button>
                            <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-edit-btn">Отмена</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <p>Комментариев пока нет.</p>
    {% endfor %}
</div>
{% endblock %}