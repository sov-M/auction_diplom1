<!-- templates/base.html -->
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="{% static 'main/favicon.ico' %}">
    <title>Аукционы</title>
</head>

<body class="container" data-page="{% block page_id %}{% endblock %}">
    <ul class="list-group">
        <li class="list-group-item">
            {% if user.is_authenticated %}
            <a href="{% url 'profile' %}">{{ user.username }}</a>
            {% else %}
            Гость
            {% endif %}
        </li>
        <li class="list-group-item">
            <a href="{% url 'home' %}">Главная</a>
            {% if user.is_authenticated %}
            <form action="{% url 'logout' %}" method="post" class="d-inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-link">Выйти</button>
            </form>
            | <a href="{% url 'create_lot' %}">Создать лот</a>
            {% else %}
            | <a href="{% url 'login' %}">Войти</a> | <a href="{% url 'register' %}">Регистрация</a>
            {% endif %}
        </li>
    </ul>

    {% if messages %}
    <div class="alert alert-info">
        {% for message in messages %}
        {{ message }}
        {% endfor %}
    </div>
    {% endif %}

    {% block content %}
    {% endblock %}

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const pageId = document.body.dataset.page;
            const updateInterval = 5000;
            let lastData = null;

            // Функция для форматирования времени до окончания
            function formatTimeUntil(seconds) {
                if (seconds <= 0) return '';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                if (hours >= 1) return `${hours} ч`;
                return `${minutes} мин`;
            }

            function updatePageData() {
                fetch(window.location.href, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (JSON.stringify(data) === JSON.stringify(lastData)) return;
                        lastData = data;

                        if (pageId === 'lot_detail') {
                            // Обновление текущей цены
                            const currentPriceEl = document.getElementById('current-price');
                            if (currentPriceEl) {
                                currentPriceEl.textContent = data.current_price ? data.current_price : 'Нет ставок';
                            }

                            // Обновление списка участников
                            const biddersListEl = document.getElementById('bidders-list');
                            if (biddersListEl) {
                                biddersListEl.innerHTML = '';
                                if (data.bidders.length > 0) {
                                    let html = '<p>Все участники:</p><ul class="list-group">';
                                    data.bidders.forEach(bidder => {
                                        const isCurrent = data.current_price && bidder.amount === data.current_price;
                                        html += `<li class="list-group-item ${isCurrent ? 'list-group-item-success' : ''}">${bidder.username} (ставка: ${bidder.amount})</li>`;
                                    });
                                    html += '</ul>';
                                    biddersListEl.innerHTML = html;
                                } else {
                                    biddersListEl.innerHTML = '<p>Ставок пока нет.</p>';
                                }
                            }

                            // Обновление времени до окончания
                            const timeUntilEl = document.getElementById('time-until');
                            if (timeUntilEl) {
                                if (data.is_auction_ended) {
                                    timeUntilEl.remove();
                                    if (!document.getElementById('auction-ended-message')) {
                                        const message = document.createElement('p');
                                        message.id = 'auction-ended-message';
                                        message.textContent = 'Аукцион завершен.';
                                        document.querySelector('.col-md-6')?.appendChild(message);
                                    }
                                } else {
                                    timeUntilEl.textContent = `Время до окончания: ${formatTimeUntil(data.time_until)}`;
                                }
                            }

                            // Обновление комментариев
                            const commentsListEl = document.getElementById('comments-list');
                            if (commentsListEl) {
                                commentsListEl.innerHTML = '';
                                if (data.comments.length > 0) {
                                    data.comments.forEach(comment => {
                                        const date = new Date(comment.created_at).toLocaleString();
                                        let commentHtml = `
                                            <div class="card mt-2" id="comment-${comment.id}">
                                                <div class="card-body">
                                                    <p>${comment.content}</p>
                                                    <p>Автор: ${comment.username} | ${date}</p>
                                        `;
                                        if (comment.can_edit) {
                                            commentHtml += `
                                                <button class="btn btn-sm btn-warning edit-comment-btn" data-comment-id="${comment.id}">Редактировать</button>
                                                <form method="post" style="display:inline;" onsubmit="return confirm('Удалить комментарий?');" class="delete-comment-form">
                                                    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                    <input type="hidden" name="delete_comment" value="true">
                                                    <input type="hidden" name="comment_id" value="${comment.id}">
                                                    <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                                                </form>
                                                <form method="post" class="edit-comment-form" style="display:none;" data-comment-id="${comment.id}">
                                                    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                    <textarea name="content" rows="3" class="form-control">${comment.content}</textarea>
                                                    <input type="hidden" name="edit_comment" value="true">
                                                    <input type="hidden" name="comment_id" value="${comment.id}">
                                                    <button type="submit" class="btn btn-sm btn-success mt-2">Сохранить</button>
                                                    <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-edit-btn">Отмена</button>
                                                </form>
                                            `;
                                        }
                                        if (!data.is_auction_ended) {
                                            commentHtml += `
                                                <button class="btn btn-sm btn-primary reply-comment-btn" data-comment-id="${comment.id}">Ответить</button>
                                                <form method="post" class="reply-comment-form" style="display:none;" data-comment-id="${comment.id}">
                                                    <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                    <textarea name="content" rows="3" class="form-control" placeholder="Ваш ответ"></textarea>
                                                    <input type="hidden" name="comment" value="true">
                                                    <input type="hidden" name="parent" value="${comment.id}">
                                                    <button type="submit" class="btn btn-sm btn-primary mt-2">Отправить ответ</button>
                                                    <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-reply-btn">Отмена</button>
                                                </form>
                                            `;
                                        }
                                        if (comment.replies_count > 0) {
                                            commentHtml += `
                                                <button class="btn btn-sm btn-info show-replies-btn" data-comment-id="${comment.id}" data-replies-count="${comment.replies_count}">
                                                    Показать ответы (${comment.replies_count})
                                                </button>
                                                <div class="replies-container" id="replies-${comment.id}" style="display:none;">
                                            `;
                                            comment.replies.forEach(reply => {
                                                const replyDate = new Date(reply.created_at).toLocaleString();
                                                commentHtml += `
                                                    <div class="card mt-2 ms-4" id="comment-${reply.id}">
                                                        <div class="card-body">
                                                            <p>${reply.content}</p>
                                                            <p>Автор: ${reply.username} | ${replyDate}</p>
                                                `;
                                                if (reply.can_edit) {
                                                    commentHtml += `
                                                        <button class="btn btn-sm btn-warning edit-comment-btn" data-comment-id="${reply.id}">Редактировать</button>
                                                        <form method="post" style="display:inline;" onsubmit="return confirm('Удалить ответ?');" class="delete-comment-form">
                                                            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                            <input type="hidden" name="delete_comment" value="true">
                                                            <input type="hidden" name="comment_id" value="${reply.id}">
                                                            <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
                                                        </form>
                                                        <form method="post" class="edit-comment-form" style="display:none;" data-comment-id="${reply.id}">
                                                            <input type="hidden" name="csrfmiddlewaretoken" value="${document.querySelector('[name=csrfmiddlewaretoken]').value}">
                                                            <textarea name="content" rows="3" class="form-control">${reply.content}</textarea>
                                                            <input type="hidden" name="edit_comment" value="true">
                                                            <input type="hidden" name="comment_id" value="${reply.id}">
                                                            <button type="submit" class="btn btn-sm btn-success mt-2">Сохранить</button>
                                                            <button type="button" class="btn btn-sm btn-secondary mt-2 cancel-edit-btn">Отмена</button>
                                                        </form>
                                                    `;
                                                }
                                                commentHtml += `
                                                        </div>
                                                    </div>
                                                `;
                                            });
                                            commentHtml += `
                                                </div>
                                            `;
                                        }
                                        commentHtml += `
                                                </div>
                                            </div>
                                        `;
                                        commentsListEl.innerHTML += commentHtml;
                                    });
                                } else {
                                    commentsListEl.innerHTML = '<p>Комментариев пока нет.</p>';
                                }
                            }

                            // Удаление форм при завершении аукциона
                            if (data.is_auction_ended) {
                                document.getElementById('bid-form')?.remove();
                                document.getElementById('comment-form')?.remove();
                                if (!document.getElementById('auction-ended-message')) {
                                    const message = document.createElement('p');
                                    message.id = 'auction-ended-message';
                                    message.textContent = 'Аукцион завершен.';
                                    document.querySelector('.col-md-6')?.appendChild(message);
                                }
                            }

                            bindCommentEvents();
                        }
                    })
                    .catch(error => console.error('Error updating page data:', error));
            }

            function bindCommentEvents() {
                document.querySelectorAll('.edit-comment-btn').forEach(button => {
                    button.removeEventListener('click', handleEditClick);
                    button.addEventListener('click', handleEditClick);
                });

                document.querySelectorAll('.cancel-edit-btn').forEach(button => {
                    button.removeEventListener('click', handleCancelEdit);
                    button.addEventListener('click', handleCancelEdit);
                });

                document.querySelectorAll('.reply-comment-btn').forEach(button => {
                    button.removeEventListener('click', handleReplyClick);
                    button.addEventListener('click', handleReplyClick);
                });

                document.querySelectorAll('.cancel-reply-btn').forEach(button => {
                    button.removeEventListener('click', handleCancelReply);
                    button.addEventListener('click', handleCancelReply);
                });

                document.querySelectorAll('.show-replies-btn').forEach(button => {
                    button.removeEventListener('click', handleShowReplies);
                    button.addEventListener('click', handleShowReplies);
                });
            }

            function handleEditClick() {
                const commentId = this.dataset.commentId;
                const commentCard = document.getElementById(`comment-${commentId}`);
                const editForm = commentCard.querySelector('.edit-comment-form');
                const replyForm = commentCard.querySelector('.reply-comment-form');
                if (editForm) {
                    editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
                    if (replyForm) {
                        replyForm.style.display = 'none';
                    }
                }
            }

            function handleCancelEdit() {
                const form = this.closest('.edit-comment-form');
                form.style.display = 'none';
            }

            function handleReplyClick() {
                const commentId = this.dataset.commentId;
                const commentCard = document.getElementById(`comment-${commentId}`);
                const replyForm = commentCard.querySelector('.reply-comment-form');
                const editForm = commentCard.querySelector('.edit-comment-form');
                if (replyForm) {
                    replyForm.style.display = replyForm.style.display === 'none' ? 'block' : 'none';
                    if (editForm) {
                        editForm.style.display = 'none';
                    }
                }
            }

            function handleCancelReply() {
                const form = this.closest('.reply-comment-form');
                form.style.display = 'none';
            }

            function handleShowReplies() {
                const commentId = this.dataset.commentId;
                const repliesContainer = document.getElementById(`replies-${commentId}`);
                if (repliesContainer) {
                    const isHidden = repliesContainer.style.display === 'none';
                    repliesContainer.style.display = isHidden ? 'block' : 'none';
                    const repliesCount = this.dataset.repliesCount || this.textContent.match(/\d+/)?.[0] || 0;
                    this.textContent = isHidden ? `Скрыть ответы` : `Показать ответы (${repliesCount})`;
                    this.dataset.repliesCount = repliesCount;
                }
            }

            if (pageId) {
                setInterval(updatePageData, updateInterval);
                updatePageData();
                bindCommentEvents();
            }
        });
    </script>
</body>

</html>